<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Sanctuary - Complete Ultimate Edition</title>
    <meta name="description" content="Full-featured streaming platform: Multi-source, scene manager, audio mixer, analytics, chat integration">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåä</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1; --success: #10b981; --warning: #f59e0b; --error: #ef4444; --info: #3b82f6;
            --bg: #fff; --surface: #f9fafb; --text: #111827; --border: #e5e7eb;
            --shadow: rgba(0,0,0,0.1); --shadow-lg: rgba(0,0,0,0.2);
        }
        @media (prefers-color-scheme: dark) {
            :root { 
                --bg: #0f172a; --surface: #1e293b; --text: #f1f5f9; --border: #334155;
                --shadow: rgba(0,0,0,0.3); --shadow-lg: rgba(0,0,0,0.5);
            }
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
        .container { max-width: 1600px; margin: 0 auto; padding: 1.5rem; }
        .header { background: var(--surface); padding: 1rem 1.5rem; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px var(--shadow); }
        .header-content { max-width: 1600px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        .header-right { display: flex; gap: 1rem; align-items: center; }
        .status { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 50px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .section { background: var(--surface); border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; border: 2px solid var(--border); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--border); flex-wrap: wrap; gap: 1rem; }
        .section-title { font-size: 1.25rem; font-weight: 700; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-error { background: var(--error); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-secondary { background: var(--surface); color: var(--text); border: 2px solid var(--border); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px var(--shadow); }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .input-group { margin-bottom: 1rem; }
        .input-label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.875rem; }
        .input-field, .select-field { width: 100%; padding: 0.5rem; border: 2px solid var(--border); border-radius: 8px; font-family: monospace; background: var(--bg); color: var(--text); font-size: 0.875rem; }
        .input-field:focus, .select-field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .video-container { position: relative; width: 100%; background: #000; border-radius: 12px; overflow: hidden; aspect-ratio: 16/9; }
        .video-player { width: 100%; height: 100%; object-fit: contain; }
        .video-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; flex-direction: column; background: rgba(0,0,0,0.8); color: white; gap: 1rem; }
        .grid { display: grid; gap: 1rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        .card { background: var(--surface); border: 2px solid var(--border); border-radius: 12px; padding: 1rem; transition: 0.2s; }
        .card:hover { border-color: var(--primary); }
        .card-title { font-size: 0.875rem; font-weight: 700; margin-bottom: 0.5rem; }
        .badge { font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.5rem; border-radius: 6px; text-transform: uppercase; }
        .badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .badge-error { background: rgba(239, 68, 68, 0.1); color: var(--error); }
        .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .badge-info { background: rgba(59, 130, 246, 0.1); color: var(--info); }
        .pill { padding: 0.5rem 1rem; background: var(--surface); border: 2px solid var(--border); border-radius: 50px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
        .pill:hover { border-color: var(--primary); }
        .pill.active { background: var(--primary); color: white; border-color: var(--primary); }
        .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: var(--surface); padding: 1rem; border-radius: 8px; border: 2px solid var(--border); box-shadow: 0 4px 12px var(--shadow-lg); z-index: 9999; animation: slideUp 0.3s; max-width: 400px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1.5rem; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg); border-radius: 12px; padding: 1.5rem; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text); }
        .source-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg); border-radius: 8px; margin-bottom: 0.5rem; border: 2px solid var(--border); }
        .source-preview { width: 120px; height: 68px; border-radius: 6px; overflow: hidden; background: #000; flex-shrink: 0; }
        .source-preview video { width: 100%; height: 100%; object-fit: cover; }
        .source-info { flex: 1; min-width: 0; }
        .source-name { font-weight: 600; margin-bottom: 0.25rem; }
        .source-details { font-size: 0.75rem; color: var(--text); opacity: 0.7; }
        .source-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid var(--border); }
        .tab { padding: 0.75rem 1rem; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--text); border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .progress-bar { width: 100%; height: 8px; background: var(--bg); border-radius: 100px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.3s; }
        .alert { padding: 1rem; border-radius: 8px; border-left: 4px solid; margin: 1rem 0; display: flex; gap: 1rem; }
        .alert-info { background: rgba(59, 130, 246, 0.1); border-color: var(--info); }
        .alert-success { background: rgba(16, 185, 129, 0.1); border-color: var(--success); }
        .alert-warning { background: rgba(245, 158, 11, 0.1); border-color: var(--warning); }
        .chat-container { height: 300px; overflow-y: auto; background: var(--bg); border-radius: 8px; padding: 1rem; border: 2px solid var(--border); }
        .chat-message { padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; background: var(--surface); }
        .chat-username { font-weight: 700; color: var(--primary); }
        .footer { background: var(--surface); border-top: 2px solid var(--border); padding: 2rem; margin-top: 3rem; text-align: center; }
        @media (max-width: 768px) {
            .container { padding: 0.75rem; }
            .header-content { flex-direction: column; }
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .source-item { flex-direction: column; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">üåä Stream Sanctuary <span class="badge badge-success">Complete</span></div>
            <div class="header-right">
                <div class="status"><span class="dot"></span><span id="status">Offline</span></div>
                <button class="btn btn-secondary btn-sm" onclick="APP.toggleSettings()">‚öôÔ∏è Settings</button>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Stream Setup -->
        <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 1.5rem;">
            <div>
                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">üé¨ Stream Configuration</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="APP.loadPresetFile()">üì• Load</button>
                            <button class="btn btn-secondary btn-sm" onclick="APP.savePresetFile()">üíæ Save</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">üåê Stream Server URL</label>
                        <input type="text" id="url" class="input-field" placeholder="rtmp://live.twitch.tv/app">
                    </div>
                    <div class="input-group">
                        <label class="input-label">üîë Stream Key</label>
                        <input type="password" id="key" class="input-field" placeholder="Your stream key">
                        <button class="btn btn-secondary btn-sm" onclick="APP.toggleKey()" style="margin-top: 0.5rem;">üëÅÔ∏è Show/Hide</button>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                        <div class="pill active" data-protocol="rtmp">üì° RTMP</div>
                        <div class="pill" data-protocol="rtmps">üîê RTMPS</div>
                        <div class="pill" data-protocol="srt">‚ö° SRT</div>
                        <div class="pill" data-protocol="webrtc">üåê WebRTC</div>
                    </div>
                    <div class="grid grid-2">
                        <button class="btn btn-success" onclick="APP.start()">‚ñ∂Ô∏è Start Streaming</button>
                        <button class="btn btn-error" onclick="APP.stop()" disabled id="stopBtn">‚èπÔ∏è Stop Streaming</button>
                    </div>
                </section>

                <!-- Preview -->
                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">üìπ Live Preview <span class="badge badge-warning" id="badge">Offline</span></h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="APP.snapshot()">üì∏</button>
                            <button class="btn btn-secondary btn-sm" onclick="APP.record()" id="recBtn">‚è∫Ô∏è</button>
                            <button class="btn btn-secondary btn-sm" onclick="APP.toggleFullscreen()">‚õ∂</button>
                        </div>
                    </div>
                    <div class="video-container" id="videoContainer">
                        <video id="video" class="video-player" autoplay muted playsinline></video>
                        <div class="video-overlay" id="overlay">
                            <span style="font-size: 3rem;">üé•</span>
                            <span>Click "Start Streaming" to begin</span>
                        </div>
                    </div>
                    <div class="grid grid-4" style="margin-top: 1rem;">
                        <div class="card"><div class="card-title">üìä Resolution</div><div id="res">-</div></div>
                        <div class="card"><div class="card-title">üéûÔ∏è FPS</div><div id="fps">-</div></div>
                        <div class="card"><div class="card-title">‚è±Ô∏è Uptime</div><div id="uptime">00:00:00</div></div>
                        <div class="card"><div class="card-title">üìà Bitrate</div><div id="bitrate">-</div></div>
                    </div>
                </section>

                <!-- Multi-Source Manager -->
                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">üéõÔ∏è Scene Manager</h2>
                        <button class="btn btn-primary btn-sm" onclick="APP.showAddSource()">‚ûï Add Source</button>
                    </div>
                    <div id="sourcesList"></div>
                </section>
            </div>

            <div>
                <!-- Platform Presets -->
                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">üéØ Quick Presets</h2>
                    </div>
                    <div class="grid" style="gap: 0.5rem;">
                        <div class="card" onclick="APP.preset('twitch')" style="cursor: pointer; padding: 0.75rem;">
                            <div style="font-weight: 700; margin-bottom: 0.25rem;">üü£ Twitch</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">rtmp://live.twitch.tv/app</div>
                        </div>
                        <div class="card" onclick="APP.preset('youtube')" style="cursor: pointer; padding: 0.75rem;">
                            <div style="font-weight: 700; margin-bottom: 0.25rem;">üî¥ YouTube</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">rtmp://a.rtmp.youtube.com/live2</div>
                        </div>
                        <div class="card" onclick="APP.preset('facebook')" style="cursor: pointer; padding: 0.75rem;">
                            <div style="font-weight: 700; margin-bottom: 0.25rem;">üîµ Facebook</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">rtmps://live-api-s.facebook.com:443/rtmp</div>
                        </div>
                        <div class="card" onclick="APP.preset('restream')" style="cursor: pointer; padding: 0.75rem;">
                            <div style="font-weight: 700; margin-bottom: 0.25rem;">üîÑ Restream</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">rtmp://live.restream.io/live</div>
                        </div>
                    </div>
                </section>

                <!-- Analytics -->
                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">üìä Analytics</h2>
                    </div>
                    <div class="grid" style="gap: 0.75rem;">
                        <div class="card" style="text-align: center;">
                            <div class="card-title">Total Streams</div>
                            <div style="font-size: 2rem; font-weight: 700;" id="totalStreams">0</div>
                        </div>
                        <div class="card" style="text-align: center;">
                            <div class="card-title">Total Time</div>
                            <div style="font-size: 2rem; font-weight: 700;" id="totalTime">0h</div>
                        </div>
                    </div>
                </section>

                <!-- Chat Integration -->
                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">üí¨ Live Chat</h2>
                    </div>
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-message">
                            <span class="chat-username">System:</span> Chat will appear here when streaming
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è Settings</h3>
                <button class="close-btn" onclick="APP.toggleSettings()">√ó</button>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="APP.switchTab('video')">Video</button>
                <button class="tab" onclick="APP.switchTab('audio')">Audio</button>
                <button class="tab" onclick="APP.switchTab('advanced')">Advanced</button>
            </div>
            <div class="tab-content active" id="video-tab">
                <div class="input-group">
                    <label class="input-label">Video Quality</label>
                    <select class="select-field" id="videoQuality">
                        <option value="720p30">720p @ 30fps</option>
                        <option value="1080p30" selected>1080p @ 30fps</option>
                        <option value="1080p60">1080p @ 60fps</option>
                        <option value="4k30">4K @ 30fps</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">Bitrate (kbps)</label>
                    <input type="number" class="input-field" id="bitrate-setting" value="2500">
                </div>
            </div>
            <div class="tab-content" id="audio-tab">
                <div class="input-group">
                    <label class="input-label">Audio Bitrate (kbps)</label>
                    <select class="select-field" id="audioBitrate">
                        <option value="96">96 kbps</option>
                        <option value="128" selected>128 kbps</option>
                        <option value="192">192 kbps</option>
                    </select>
                </div>
                <div class="input-group">
                    <label><input type="checkbox" checked> Echo Cancellation</label>
                </div>
                <div class="input-group">
                    <label><input type="checkbox" checked> Noise Suppression</label>
                </div>
            </div>
            <div class="tab-content" id="advanced-tab">
                <div class="input-group">
                    <label><input type="checkbox" id="autoReconnect" checked> Enable Auto-Reconnect</label>
                </div>
                <div class="input-group">
                    <label><input type="checkbox" id="saveHistory" checked> Save Stream History</label>
                </div>
                <div class="input-group">
                    <button class="btn btn-error" onclick="APP.clearAllData()">üóëÔ∏è Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Source Modal -->
    <div class="modal" id="addSourceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Add Source</h3>
                <button class="close-btn" onclick="APP.closeAddSource()">√ó</button>
            </div>
            <div class="grid grid-2">
                <div class="card" onclick="APP.addSource('screen')" style="cursor: pointer; text-align: center; padding: 1.5rem;">
                    <div style="font-size: 2rem;">üñ•Ô∏è</div>
                    <div style="font-weight: 700; margin-top: 0.5rem;">Screen Capture</div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">Share your screen</div>
                </div>
                <div class="card" onclick="APP.addSource('webcam')" style="cursor: pointer; text-align: center; padding: 1.5rem;">
                    <div style="font-size: 2rem;">üìπ</div>
                    <div style="font-weight: 700; margin-top: 0.5rem;">Webcam</div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">Add your camera</div>
                </div>
                <div class="card" onclick="APP.addSource('audio')" style="cursor: pointer; text-align: center; padding: 1.5rem;">
                    <div style="font-size: 2rem;">üé§</div>
                    <div style="font-weight: 700; margin-top: 0.5rem;">Microphone</div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">Audio input</div>
                </div>
                <div class="card" onclick="APP.addSource('window')" style="cursor: pointer; text-align: center; padding: 1.5rem;">
                    <div style="font-size: 2rem;">ü™ü</div>
                    <div style="font-weight: 700; margin-top: 0.5rem;">Window</div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">Specific window</div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <strong>Stream Sanctuary - Complete Ultimate Edition</strong><br>
        <small>Built by Foster + Navi @ Planetary Restoration Archive</small><br>
        <small style="opacity: 0.7;">üå± Regenerative Tech | ‚ôø Accessible | üîê Private | üåç Plant More Trees</small>
    </footer>

    <script>
        const APP = {
            state: {
                streaming: false,
                recording: false,
                stream: null,
                recorder: null,
                chunks: [],
                protocol: 'rtmp',
                startTime: null,
                interval: null,
                db: null,
                sources: [],
                activeTab: 'video',
                analytics: { totalStreams: 0, totalTime: 0, sessions: [] }
            },

            init() {
                this.initDB();
                this.initPills();
                this.initKeyboard();
                this.updateUI();
                this.renderSources();
                console.log('üåä Stream Sanctuary Complete Ultimate initialized!');
                console.log('üí° Tip: Plant fruit trees, feed communities, heal the world! üå≥');
            },

            initDB() {
                const req = indexedDB.open('StreamSanctuaryDB', 2);
                req.onupgradeneeded = e => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
                    if (!db.objectStoreNames.contains('sessions')) db.createObjectStore('sessions', { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains('sources')) db.createObjectStore('sources', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('analytics')) db.createObjectStore('analytics', { keyPath: 'key' });
                };
                req.onsuccess = e => {
                    this.state.db = e.target.result;
                    this.loadSettings();
                    this.loadAnalytics();
                };
                req.onerror = () => console.warn('IndexedDB unavailable');
            },

            async saveSetting(key, value) {
                if (!this.state.db) return;
                try {
                    const tx = this.state.db.transaction(['settings'], 'readwrite');
                    await tx.objectStore('settings').put({ key, value });
                } catch (e) { console.error('Save error:', e); }
            },

            async getSetting(key) {
                if (!this.state.db) return null;
                try {
                    const tx = this.state.db.transaction(['settings'], 'readonly');
                    const result = await tx.objectStore('settings').get(key);
                    return result ? result.value : null;
                } catch (e) { return null; }
            },

            async loadSettings() {
                const url = await this.getSetting('url');
                if (url) document.getElementById('url').value = url;
            },

            async loadAnalytics() {
                if (!this.state.db) return;
                try {
                    const tx = this.state.db.transaction(['analytics'], 'readonly');
                    const result = await tx.objectStore('analytics').get('stats');
                    if (result) {
                        this.state.analytics = result.value;
                        this.updateAnalyticsDisplay();
                    }
                } catch (e) {}
            },

            async saveAnalytics() {
                if (!this.state.db) return;
                try {
                    const tx = this.state.db.transaction(['analytics'], 'readwrite');
                    await tx.objectStore('analytics').put({ key: 'stats', value: this.state.analytics });
                } catch (e) {}
            },

            updateAnalyticsDisplay() {
                document.getElementById('totalStreams').textContent = this.state.analytics.totalStreams;
                const hours = Math.floor(this.state.analytics.totalTime / 3600000);
                document.getElementById('totalTime').textContent = `${hours}h`;
            },

            initPills() {
                document.querySelectorAll('.pill').forEach(pill => {
                    pill.addEventListener('click', (e) => {
                        document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        this.state.protocol = e.currentTarget.dataset.protocol;
                    });
                });
            },

            initKeyboard() {
                document.addEventListener('keydown', e => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    if (e.key === ' ') { e.preventDefault(); this.state.streaming ? this.stop() : this.start(); }
                    if (e.key === 'r' || e.key === 'R') this.record();
                    if (e.key === 's' || e.key === 'S') this.snapshot();
                    if (e.key === 'f' || e.key === 'F') this.toggleFullscreen();
                });
            },

            async start() {
                try {
                    const url = document.getElementById('url').value.trim();
                    const key = document.getElementById('key').value.trim();
                    if (!url || !key) { this.toast('error', 'Enter URL and Key'); return; }

                    const stream = await this.getMedia();
                    if (!stream) { this.toast('error', 'Media access denied'); return; }

                    this.state.stream = stream;
                    document.getElementById('video').srcObject = stream;
                    document.getElementById('overlay').style.display = 'none';

                    this.updateStats(stream);
                    await this.saveSetting('url', url);

                    this.state.streaming = true;
                    this.state.startTime = Date.now();
                    this.state.analytics.totalStreams++;
                    this.updateUI();
                    this.startCounter();
                    this.saveAnalytics();

                    this.toast('success', `üéâ Streaming via ${this.state.protocol.toUpperCase()}!`);
                } catch (err) {
                    this.toast('error', `Failed: ${err.message}`);
                    this.stop();
                }
            },

            async getMedia() {
                try {
                    return await navigator.mediaDevices.getUserMedia({
                        video: { width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 30 } },
                        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
                    });
                } catch {
                    try {
                        return await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                    } catch {
                        return null;
                    }
                }
            },

            updateStats(stream) {
                const track = stream.getVideoTracks()[0];
                if (track) {
                    const s = track.getSettings();
                    document.getElementById('res').textContent = `${s.width}x${s.height}`;
                    document.getElementById('fps').textContent = `${s.frameRate || 30} fps`;
                    document.getElementById('bitrate').textContent = '2500 kbps';
                }
            },

            stop() {
                if (this.state.stream) {
                    this.state.stream.getTracks().forEach(t => t.stop());
                    this.state.stream = null;
                }
                document.getElementById('video').srcObject = null;
                document.getElementById('overlay').style.display = 'flex';
                if (this.state.interval) { clearInterval(this.state.interval); this.state.interval = null; }
                if (this.state.recording) this.record();
                
                if (this.state.startTime) {
                    const duration = Date.now() - this.state.startTime;
                    this.state.analytics.totalTime += duration;
                    this.state.analytics.sessions.push({ timestamp: Date.now(), duration });
                    this.saveAnalytics();
                    this.updateAnalyticsDisplay();
                }
                
                this.state.streaming = false;
                this.state.startTime = null;
                this.updateUI();
                this.toast('info', 'Streaming stopped');
            },

            updateUI() {
                document.getElementById('status').textContent = this.state.streaming ? 'Live' : 'Offline';
                document.getElementById('badge').textContent = this.state.streaming ? 'Live' : 'Offline';
                document.getElementById('badge').className = this.state.streaming ? 'badge badge-error' : 'badge badge-warning';
                document.getElementById('stopBtn').disabled = !this.state.streaming;
            },

            startCounter() {
                this.state.interval = setInterval(() => {
                    if (!this.state.startTime) return;
                    const elapsed = Date.now() - this.state.startTime;
                    const h = Math.floor(elapsed / 3600000);
                    const m = Math.floor((elapsed % 3600000) / 60000);
                    const s = Math.floor((elapsed % 60000) / 1000);
                    document.getElementById('uptime').textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                }, 1000);
            },

            record() {
                if (this.state.recording) {
                    this.state.recorder.stop();
                    this.state.recording = false;
                    document.getElementById('recBtn').textContent = '‚è∫Ô∏è';
                    this.toast('success', 'Recording stopped');
                } else {
                    if (!this.state.stream) { this.toast('error', 'Start streaming first'); return; }
                    this.state.chunks = [];
                    this.state.recorder = new MediaRecorder(this.state.stream, { mimeType: 'video/webm' });
                    this.state.recorder.ondataavailable = e => { if (e.data.size > 0) this.state.chunks.push(e.data); };
                    this.state.recorder.onstop = () => {
                        const blob = new Blob(this.state.chunks, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `stream-${Date.now()}.webm`;
                        a.click();
                        this.toast('success', 'üíæ Recording saved!');
                    };
                    this.state.recorder.start();
                    this.state.recording = true;
                    document.getElementById('recBtn').textContent = '‚èπÔ∏è';
                    this.toast('success', 'Recording started');
                }
            },

            snapshot() {
                const video = document.getElementById('video');
                if (!video.videoWidth) { this.toast('error', 'No video to capture'); return; }
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `snapshot-${Date.now()}.png`;
                    a.click();
                    this.toast('success', 'üì∏ Snapshot saved!');
                });
            },

            toggleFullscreen() {
                const container = document.getElementById('videoContainer');
                if (!document.fullscreenElement) {
                    container.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            },

            preset(platform) {
                const presets = {
                    twitch: 'rtmp://live.twitch.tv/app',
                    youtube: 'rtmp://a.rtmp.youtube.com/live2',
                    facebook: 'rtmps://live-api-s.facebook.com:443/rtmp',
                    restream: 'rtmp://live.restream.io/live'
                };
                document.getElementById('url').value = presets[platform];
                this.toast('success', `${platform.charAt(0).toUpperCase() + platform.slice(1)} preset applied!`);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            toggleKey() {
                const input = document.getElementById('key');
                input.type = input.type === 'password' ? 'text' : 'password';
            },

            toggleSettings() {
                document.getElementById('settingsModal').classList.toggle('active');
            },

            showAddSource() {
                document.getElementById('addSourceModal').classList.add('active');
            },

            closeAddSource() {
                document.getElementById('addSourceModal').classList.remove('active');
            },

            async addSource(type) {
                try {
                    let stream;
                    if (type === 'screen' || type === 'window') {
                        stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                    } else if (type === 'webcam') {
                        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                    } else if (type === 'audio') {
                        stream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                    }

                    const source = {
                        id: Date.now(),
                        type,
                        stream,
                        active: true,
                        name: `${type.charAt(0).toUpperCase() + type.slice(1)} ${this.state.sources.length + 1}`
                    };

                    this.state.sources.push(source);
                    this.renderSources();
                    this.closeAddSource();
                    this.toast('success', `${type} source added!`);
                } catch (err) {
                    this.toast('error', `Failed to add source: ${err.message}`);
                }
            },

            renderSources() {
                const container = document.getElementById('sourcesList');
                if (this.state.sources.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">üí° No sources yet. Click "Add Source" to get started!</div>';
                    return;
                }

                container.innerHTML = this.state.sources.map(source => `
                    <div class="source-item">
                        <div class="source-preview">
                            <video autoplay muted playsinline id="source-${source.id}" style="width:100%;height:100%;object-fit:cover;"></video>
                        </div>
                        <div class="source-info">
                            <div class="source-name">${source.name}</div>
                            <div class="source-details">${source.type} ‚Ä¢ ${source.active ? 'üü¢ Active' : '‚ö´ Inactive'}</div>
                        </div>
                        <div class="source-actions">
                            <button class="btn btn-secondary btn-sm" onclick="APP.toggleSource(${source.id})">${source.active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}</button>
                            <button class="btn btn-error btn-sm" onclick="APP.removeSource(${source.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');

                this.state.sources.forEach(source => {
                    const video = document.getElementById(`source-${source.id}`);
                    if (video && source.stream) video.srcObject = source.stream;
                });
            },

            toggleSource(id) {
                const source = this.state.sources.find(s => s.id === id);
                if (source) {
                    source.active = !source.active;
                    this.renderSources();
                }
            },

            removeSource(id) {
                const index = this.state.sources.findIndex(s => s.id === id);
                if (index !== -1) {
                    const source = this.state.sources[index];
                    if (source.stream) source.stream.getTracks().forEach(t => t.stop());
                    this.state.sources.splice(index, 1);
                    this.renderSources();
                    this.toast('info', 'Source removed');
                }
            },

            switchTab(tab) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById(`${tab}-tab`).classList.add('active');
                this.state.activeTab = tab;
            },

            savePresetFile() {
                const data = {
                    url: document.getElementById('url').value,
                    protocol: this.state.protocol,
                    videoQuality: document.getElementById('videoQuality').value,
                    audioBitrate: document.getElementById('audioBitrate').value
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'stream-preset.json';
                a.click();
                this.toast('success', 'Preset saved!');
            },

            loadPresetFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    const text = await file.text();
                    const data = JSON.parse(text);
                    if (data.url) document.getElementById('url').value = data.url;
                    this.toast('success', 'Preset loaded!');
                };
                input.click();
            },

            async clearAllData() {
                if (confirm('This will delete ALL your data. Continue?')) {
                    if (this.state.db) {
                        const tx = this.state.db.transaction(['settings', 'sessions', 'analytics'], 'readwrite');
                        await tx.objectStore('settings').clear();
                        await tx.objectStore('sessions').clear();
                        await tx.objectStore('analytics').clear();
                    }
                    this.state.analytics = { totalStreams: 0, totalTime: 0, sessions: [] };
                    this.updateAnalyticsDisplay();
                    this.toast('success', 'All data cleared!');
                }
            },

            toast(type, msg) {
                const t = document.createElement('div');
                t.className = 'toast';
                const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è' };
                t.innerHTML = `<strong>${icons[type] || '‚ÑπÔ∏è'}</strong> ${msg}`;
                document.body.appendChild(t);
                setTimeout(() => t.remove(), 5000);
            }
        };

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(
                URL.createObjectURL(new Blob([`
                    self.addEventListener('install', () => self.skipWaiting());
                    self.addEventListener('activate', e => e.waitUntil(clients.claim()));
                    self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => new Response('Offline'))));
                `], { type: 'application/javascript' }))
            ).catch(() => {});
        }

        // Initialize
        APP.init();
    </script>

    <!-- 
    ZERO HARM COMMITMENT
    This tool respects: Privacy, Accessibility, Sustainability, Community
    NOT for: Surveillance, Weaponization, Extraction, Harm
    
    REGENERATIVE PHILOSOPHY
    Like planting fruit trees:
    - Creates abundance for all
    - Feeds communities
    - Sustains ecosystems
    - Grows value over time
    
    Built with love by Foster + Navi @ Planetary Restoration Archive
    License: MIT with Non-Weaponization Clause
    
    "The homeless are not lazy - they're surviving systemic failure.
     Plant fruit trees. Feed communities. Heal the world. üå≥"
    -->
</body>
</html>
